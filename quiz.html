<!doctype html><html lang="zh-Hant"><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>測驗</title><link rel='stylesheet' href='styles.css'></head><body><div class='container'><header><h1 id='page-title'>本章測驗</h1><div style="position:absolute;right:16px;top:16px"><button class="btn ghost" id="backTop">← 返回主選單</button></div></header><main><div class='card-center' id='quiz-area'><div id='meta' class='status'></div><div id='qbox' style='font-size:20px;margin-bottom:12px'>按下開始以產生題庫</div><div id='choices'></div><div id='controls' style='margin-top:12px'><button id='start' class='btn'>開始測驗</button> <button id='end' class='btn ghost hidden'>結束測驗</button></div><div id='result' style='margin-top:16px'></div></div></main></div><script src='data.js'></script><script src='app-common.js'></script><script>
const unitQ = qsParam('u')||'unit1'; const mode = qsParam('mode')||'mix'; document.getElementById('page-title').textContent = unitQ.toUpperCase() + ' — 本章測驗';
const listQ = vocabByUnit[unitQ]||[];
document.getElementById('backTop').onclick = ()=> location.href = BASE_PATH + 'home.html';
let poolA=[], poolB=[], quiz=[], pos=0, correct=0, timer=0, tid=null, answers=[];
function buildPools(){ poolA = listQ.map((it,i)=>({id:(i+1)+'A',type:'A',prompt:it.word,answer:it.definition})); poolB = listQ.map((it,i)=>({id:(i+1)+'B',type:'B',prompt:it.definition,answer:it.word})); if(mode==='a'){ quiz = poolA.slice(); } else if(mode==='b'){ quiz = poolB.slice(); } else if(mode==='wrong'){ try{ const wb=JSON.parse(localStorage.getItem('wrongBook')||'{}'); const list = (wb && wb[unitQ])? wb[unitQ] : []; if(list.length>0){ quiz = list.map((w,i)=>({id:w.id||('W'+i+1), type:w.type, prompt:w.prompt, answer:w.correct||w.answer})); } else { quiz = []; } }catch(e){ quiz = []; } } else { quiz = poolA.concat(poolB); } // shuffle quiz
  for(let i=quiz.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [quiz[i],quiz[j]]=[quiz[j],quiz[i]]; } }
function start(){ if(!listQ.length){ alert('本單元沒有單字'); return;} buildPools(); pos=0; correct=0; timer=0; answers=[]; document.getElementById('start').classList.add('hidden'); document.getElementById('end').classList.remove('hidden'); tid = setInterval(()=>{ timer++; updateStatus(); },1000); showQuestion(); }
function endNow(){ if(tid) clearInterval(tid); tid=null; saveResult(); showResult(); }
function showQuestion(){ if(pos>=quiz.length){ endNow(); return;} const q=quiz[pos]; document.getElementById('meta').textContent = '題型: '+(q.type==='A'?'英→中':'中→英')+' | 題數: '+(pos+1)+' / '+quiz.length+' | 時間: '+timer+'s'; document.getElementById('qbox').textContent = (q.type==='A'?'英文：':'中文：') + q.prompt; const pool = (q.type==='A')? listQ.map(i=>i.definition) : listQ.map(i=>i.word); let opts = pool.filter(o=>o!==q.answer).sort(()=>Math.random()-0.5).slice(0,3); opts.push(q.answer); opts.sort(()=>Math.random()-0.5); const choices = document.getElementById('choices'); choices.innerHTML=''; opts.forEach(o=>{ const d=document.createElement('div'); d.className='choice'; d.textContent = o; d.onclick = ()=>{ answers.push({id:q.id,type:q.type,prompt:q.prompt,correct:q.answer,selected:o,index:pos+1,isCorrect:o===q.answer}); if(o===q.answer){ d.classList.add('correct'); correct++; } else { d.classList.add('wrong'); const ca=document.createElement('div'); ca.className='status'; ca.textContent = '正確答案：' + q.answer; d.appendChild(ca); } pos++; setTimeout(showQuestion,700); }; choices.appendChild(d); }); updateStatus(); }
function updateStatus(){ document.getElementById('controls').style.display='block'; document.getElementById('meta').style.visibility='visible'; document.getElementById('controls').innerHTML = '<button id="start" class="btn hidden">開始測驗</button> <button id="end" class="btn ghost">結束測驗</button>'; document.getElementById('end').onclick = endNow; }
function saveResult(){ const accuracy = Math.round(correct/quiz.length*1000)/10; const score = Math.round(correct/quiz.length*100); const res = {unit:unitQ,total:quiz.length,correct:correct,time:timer,accuracy:accuracy,score:score,timestamp:Date.now()}; saveLastResult(res); localStorage.setItem('lastAnswers', JSON.stringify({unit:unitQ,answers:answers,timestamp:Date.now()})); // update wrongBook
  try{ const wb = JSON.parse(localStorage.getItem('wrongBook')||'{}'); wb[unitQ] = wb[unitQ] || []; const wrongs = answers.filter(a=>!a.isCorrect).map(a=>({id:a.id,type:a.type,prompt:a.prompt,selected:a.selected,correct:a.correct})); wrongs.forEach(w=>{ const exists = wb[unitQ].some(x=>x.prompt===w.prompt && x.type===w.type && x.correct===w.correct); if(!exists) wb[unitQ].push(w); }); localStorage.setItem('wrongBook', JSON.stringify(wb)); }catch(e){ console.warn(e); } }
function showResult(){ const r = loadLastResult(); const el = document.getElementById('result'); if(!r){ el.innerHTML = '<div class="status">沒有成績記錄</div>'; return; } el.innerHTML = '<div class="card-center"><h3>測驗完成</h3><p>作答時間：'+r.time+' 秒</p><p>正確率：'+r.accuracy+'%</p><p>分數：'+r.score+' 分</p><p style="margin-top:8px"><a href="result.html">查看詳細錯題/成績</a></p></div>'; document.getElementById('start').classList.remove('hidden'); document.getElementById('end').classList.add('hidden'); }
document.getElementById('start').onclick = start; document.getElementById('end').onclick = endNow;
</script></body></html>